<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ITRA Race Results Viewer</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for a better look and feel */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for a modern look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937; /* bg-gray-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563; /* bg-gray-600 */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* bg-gray-500 */
        }
        /* Style for the sort indicator */
        th .sort-indicator {
            opacity: 0.8;
            transition: opacity 0.2s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 antialiased">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <!-- Header Section -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white mb-2">ITRA Race Results Viewer üèÜ</h1>
            <p class="text-gray-400 max-w-2xl mx-auto">
                Yarƒ±≈ü sonu√ßlarƒ± <code class="bg-gray-700 text-emerald-400 px-2 py-1 rounded-md text-sm">itra_results.csv</code> dosyasƒ±ndan y√ºklenir. Sonu√ßlarƒ± anƒ±nda filtreleyebilir, sƒ±ralayabilir ve dƒ±≈üa aktarabilirsiniz.
            </p>
        </div>

        <!-- Controls Section -->
        <div class="bg-gray-800/50 backdrop-blur-sm rounded-xl shadow-lg p-6 mb-8 sticky top-4 z-10 border border-gray-700">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Search Input -->
                <div class="relative">
                     <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    </span>
                    <input type="text" id="filterInput" placeholder="Herhangi bir alanda ara..." class="w-full bg-gray-700 border border-gray-600 rounded-lg py-2 pl-10 pr-4 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition">
                </div>
                
                <!-- Filters -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 lg:col-span-1">
                    <select id="countryFilter" class="w-full bg-gray-700 border border-gray-600 rounded-lg py-2 px-4 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition">
                        <option value="">T√ºm √úlkeler</option>
                    </select>
                    <select id="genderFilter" class="w-full bg-gray-700 border border-gray-600 rounded-lg py-2 px-4 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition">
                        <option value="">T√ºm Cinsiyetler</option>
                        <option value="F">Kadƒ±n</option>
                        <option value="M">Erkek</option>
                    </select>
                </div>

                <!-- Action Buttons -->
                <div class="flex items-center justify-start md:justify-end gap-4">
                    <button id="exportButton" class="flex items-center gap-2 bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-2 px-4 rounded-lg transition-transform transform hover:scale-105">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        CSV Aktar
                    </button>
                    <button id="resetButton" class="flex items-center gap-2 bg-rose-600 hover:bg-rose-700 text-white font-semibold py-2 px-4 rounded-lg transition-transform transform hover:scale-105">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h5M20 20v-5h-5M4 4l16 16"></path></svg>
                        Sƒ±fƒ±rla
                    </button>
                </div>
            </div>
        </div>

        <!-- Table Section -->
        <div class="bg-gray-800 rounded-xl shadow-lg overflow-hidden border border-gray-700">
            <div class="overflow-x-auto">
                <table id="resultsTable" class="min-w-full text-sm">
                    <thead class="bg-gray-700/50">
                        <tr>
                            <th class="py-3 px-5 text-left font-semibold text-gray-300 cursor-pointer" data-column="raceYear">Yƒ±l <span class="sort-indicator"></span></th>
                            <th class="py-3 px-5 text-left font-semibold text-gray-300 cursor-pointer" data-column="name">ƒ∞sim/Soyisim <span class="sort-indicator"></span></th>
                            <th class="py-3 px-5 text-left font-semibold text-gray-300 cursor-pointer" data-column="country">√úlke <span class="sort-indicator"></span></th>
                            <th class="py-3 px-5 text-left font-semibold text-gray-300 cursor-pointer" data-column="time">S√ºre <span class="sort-indicator"></span></th>
                            <th class="py-3 px-5 text-left font-semibold text-gray-300 cursor-pointer" data-column="ageGroup">Ya≈ü Grubu <span class="sort-indicator"></span></th>
                            <th class="py-3 px-5 text-left font-semibold text-gray-300 cursor-pointer" data-column="gender">Cinsiyet <span class="sort-indicator"></span></th>
                            <th class="py-3 px-5 text-left font-semibold text-gray-300 cursor-pointer" data-column="raceScore">Yarƒ±≈ü Skoru <span class="sort-indicator"></span></th>
                        </tr>
                    </thead>
                    <tbody id="resultsBody" class="divide-y divide-gray-700">
                        <!-- Rows will be injected here by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Pagination Controls -->
        <div class="flex flex-col sm:flex-row items-center justify-between mt-8 text-gray-400">
             <div class="flex items-center gap-2 mb-4 sm:mb-0">
                <span>Sayfa ba≈üƒ±na:</span>
                <select id="rowsPerPageSelect" class="bg-gray-700 border border-gray-600 rounded-lg py-1 px-2 focus:outline-none focus:ring-2 focus:ring-emerald-500 transition">
                    <option value="20">20</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                    <option value="all">T√ºm√º</option>
                </select>
            </div>
            <div class="flex items-center gap-4">
                <button id="prevPageButton" class="flex items-center gap-2 bg-gray-700 hover:bg-gray-600 disabled:bg-gray-800 disabled:cursor-not-allowed disabled:text-gray-500 text-white font-semibold py-2 px-4 rounded-lg transition">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    Geri
                </button>
                <span id="pageInfo" class="font-semibold"></span>
                <button id="nextPageButton" class="flex items-center gap-2 bg-gray-700 hover:bg-gray-600 disabled:bg-gray-800 disabled:cursor-not-allowed disabled:text-gray-500 text-white font-semibold py-2 px-4 rounded-lg transition">
                    ƒ∞leri
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                </button>
            </div>
        </div>

    </div>

    <script>
        let allRunnersData = [];
        let currentPage = 1;
        let rowsPerPage = 20;

        // --- MAPPINGS and HELPERS ---
        const countryCodeMap = { "AFG": { name: "Afganistan", code: "af" },"ALB": { name: "Arnavutluk", code: "al" },"DZA": { name: "Cezayir", code: "dz" },"AND": { name: "Andorra", code: "ad" },"ARG": { name: "Arjantin", code: "ar" },"AUS": { name: "Avustralya", code: "au" },"AUT": { name: "Avusturya", code: "at" },"BEL": { name: "Bel√ßika", code: "be" },"BLR": { name: "Belarus", code: "by" },"BOL": { name: "Bolivya", code: "bo" },"BRA": { name: "Brezilya", code: "br" },"BGR": { name: "Bulgaristan", code: "bg" },"CAN": { name: "Kanada", code: "ca" },"CHL": { name: "≈ûili", code: "cl" },"CHN": { name: "√áin", code: "cn" },"COL": { name: "Kolombiya", code: "co" },"CRC": { name: "Kosta Rika", code: "cr" },"HRV": { name: "Hƒ±rvatistan", code: "hr" },"CYP": { name: "Kƒ±brƒ±s", code: "cy" },"CZE": { name: "√áekya", code: "cz" },"DNK": { name: "Danimarka", code: "dk" },"ECU": { name: "Ekvador", code: "ec" },"EST": { name: "Estonya", code: "ee" },"FIN": { name: "Finlandiya", code: "fi" },"FRA": { name: "Fransa", code: "fr" },"GEO": { name: "G√ºrcistan", code: "ge" },"DEU": { name: "Almanya", code: "de" },"GRC": { name: "Yunanistan", code: "gr" },"GTM": { name: "Guatemala", code: "gt" },"HKG": { name: "Hong Kong", code: "hk" },"HUN": { name: "Macaristan", code: "hu" },"ISL": { name: "ƒ∞zlanda", code: "is" },"IND": { name: "Hindistan", code: "in" },"IDN": { name: "Endonezya", code: "id" },"IRN": { name: "ƒ∞ran", code: "ir" },"IRL": { name: "ƒ∞rlanda", code: "ie" },"ISR": { name: "ƒ∞srail", code: "il" },"ITA": { name: "ƒ∞talya", code: "it" },"JPN": { name: "Japonya", code: "jp" },"KAZ": { name: "Kazakistan", code: "kz" },"KOR": { name: "G√ºney Kore", code: "kr" },"LVA": { name: "Letonya", code: "lv" },"LTU": { name: "Litvanya", code: "lt" },"LUX": { name: "L√ºksemburg", code: "lu" },"MYS": { name: "Malezya", code: "my" },"MEX": { name: "Meksika", code: "mx" },"MDA": { name: "Moldova", code: "md" },"MCO": { name: "Monako", code: "mc" },"NPL": { name: "Nepal", code: "np" },"NLD": { name: "Hollanda", code: "nl" },"NZL": { name: "Yeni Zelanda", code: "nz" },"MKD": { name: "Kuzey Makedonya", code: "mk" },"NOR": { name: "Norve√ß", code: "no" },"PER": { name: "Peru", code: "pe" },"PHL": { name: "Filipinler", code: "ph" },"POL": { name: "Polonya", code: "pl" },"PRT": { name: "Portekiz", code: "pt" },"ROU": { name: "Romanya", code: "ro" },"RUS": { name: "Rusya", code: "ru" },"SMR": { name: "San Marino", code: "sm" },"SRB": { name: "Sƒ±rbistan", code: "rs" },"SGP": { name: "Singapur", code: "sg" },"SVK": { name: "Slovakya", code: "sk" },"SVN": { name: "Slovenya", code: "si" },"ZAF": { name: "G√ºney Afrika", code: "za" },"ESP": { name: "ƒ∞spanya", code: "es" },"SWE": { name: "ƒ∞sve√ß", code: "se" },"CHE": { name: "ƒ∞svi√ßre", code: "ch" },"TWN": { name: "Tayvan", code: "tw" },"THA": { name: "Tayland", code: "th" },"TUR": { name: "T√ºrkiye", code: "tr" },"UKR": { name: "Ukrayna", code: "ua" },"GBR": { name: "Birle≈üik Krallƒ±k", code: "gb" },"USA": { name: "ABD", code: "us" },"URY": { name: "Uruguay", code: "uy" },"VEN": { name: "Venezuela", code: "ve" } };

        function getFlagEmoji(countryCode) {
            if (!countryCode) return '';
            const codePoints = countryCode.toUpperCase().split('').map(char => 127397 + char.charCodeAt(0));
            return String.fromCodePoint(...codePoints);
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', loadDataFromCsv);

        // --- EVENT LISTENERS ---
        document.getElementById('filterInput').addEventListener('keyup', () => { currentPage = 1; renderTable(); });
        document.getElementById('countryFilter').addEventListener('change', () => { currentPage = 1; renderTable(); });
        document.getElementById('genderFilter').addEventListener('change', () => { currentPage = 1; renderTable(); });
        document.getElementById('resetButton').addEventListener('click', resetProcess);
        document.getElementById('exportButton').addEventListener('click', exportToCsv);
        
        document.getElementById('rowsPerPageSelect').addEventListener('change', (e) => {
            rowsPerPage = e.target.value === 'all' ? Infinity : parseInt(e.target.value);
            currentPage = 1;
            renderTable();
        });
        document.getElementById('prevPageButton').addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderTable();
            }
        });
        document.getElementById('nextPageButton').addEventListener('click', () => {
            const { totalPages } = getFilteredRows();
            if (currentPage < totalPages) {
                currentPage++;
                renderTable();
            }
        });

        document.querySelectorAll('#resultsTable th').forEach(header => {
            header.addEventListener('click', () => {
                const columnKey = header.dataset.column;
                const currentDir = header.dataset.sortDir || 'desc';
                const newDir = currentDir === 'asc' ? 'desc' : 'asc';
                
                document.querySelectorAll('#resultsTable th').forEach(h => h.dataset.sortDir = '');
                
                header.dataset.sortDir = newDir;
                sortTable(columnKey, newDir);
            });
        });
        
        // --- DATA HANDLING ---
        async function loadDataFromCsv() {
             const tableBody = document.getElementById('resultsBody');
            tableBody.innerHTML = `<tr><td colspan="7" class="text-center py-10 px-5 text-gray-400">Veriler y√ºkleniyor...</td></tr>`;
            try {
                const response = await fetch('itra_results.csv');
                if (!response.ok) {
                    throw new Error('itra_results.csv dosyasƒ± bulunamadƒ± veya y√ºklenemedi. L√ºtfen dosyanƒ±n bu HTML dosyasƒ±yla aynƒ± dizinde olduƒüundan emin olun.');
                }
                const csvText = await response.text();
                
                const lines = csvText.trim().split('\n');
                lines.shift(); // Skip header

                allRunnersData = lines.map(line => {
                    const values = line.split(',').map(v => v.trim().replace(/"/g, ''));
                    return {
                        raceYear: values[0],
                        name: values[1],
                        itraLink: values[2],
                        country: values[3],
                        time: values[4],
                        ageGroup: values[5],
                        gender: values[6],
                        raceScore: values[7]
                    };
                }).filter(r => r.name); // Filter out empty lines

                updateCountryFilter();
                sortTable('time', 'asc'); // Default sort
            } catch (error) {
                console.error('CSV dosyasƒ± i≈ülenirken hata:', error);
                tableBody.innerHTML = `<tr><td colspan="7" class="text-center py-10 px-5 text-rose-400">${error.message}</td></tr>`;
            }
        }

        // --- RENDERING, FILTERING & RESET ---
        function getFilteredRows() {
            const textFilter = document.getElementById('filterInput').value.toUpperCase();
            const countryFilter = document.getElementById('countryFilter').value;
            const genderFilter = document.getElementById('genderFilter').value;

            const filteredData = allRunnersData.filter(runner => {
                const countryMatch = !countryFilter || runner.country === countryFilter;
                const genderMatch = !genderFilter || runner.gender === genderFilter;
                
                let textMatch = true;
                if (textFilter) {
                    textMatch = Object.values(runner).some(val => {
                        let stringVal = String(val || '').toUpperCase();
                        if (runner.country && countryCodeMap[runner.country] && val === runner.country) {
                           stringVal = countryCodeMap[runner.country].name.toUpperCase();
                        }
                        return stringVal.includes(textFilter);
                    });
                }
                
                return countryMatch && genderMatch && textMatch;
            });

            return {
                visibleRows: filteredData,
                totalPages: rowsPerPage === Infinity ? 1 : Math.ceil(filteredData.length / rowsPerPage)
            };
        }
        
        function renderTable() {
            const { visibleRows, totalPages } = getFilteredRows();
            const tableBody = document.getElementById('resultsBody');
            tableBody.innerHTML = ''; // Clear the table

            if (visibleRows.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="7" class="text-center py-10 px-5 text-gray-400">Filtrelerle e≈üle≈üen sonu√ß bulunamadƒ±.</td></tr>`;
                updatePaginationControls(0, 0);
                return;
            }

            if (currentPage > totalPages && totalPages > 0) {
                currentPage = totalPages;
            }

            const start = (currentPage - 1) * rowsPerPage;
            const end = (rowsPerPage === Infinity) ? visibleRows.length : (start + rowsPerPage);
            const pageRowsData = visibleRows.slice(start, end);

            pageRowsData.forEach(runner => {
                const row = tableBody.insertRow();
                const countryInfo = countryCodeMap[runner.country];
                const countryDisplay = countryInfo 
                    ? `${getFlagEmoji(countryInfo.code)} ${countryInfo.name}` 
                    : runner.country || '';

                row.className = 'hover:bg-gray-700 transition-colors duration-200';
                row.innerHTML = `
                    <td class="py-3 px-5">${runner.raceYear || ''}</td>
                    <td class="py-3 px-5 font-medium text-white">${runner.itraLink && runner.itraLink !== '#' ? `<a href="${runner.itraLink}" target="_blank" class="text-emerald-400 hover:text-emerald-300 transition">${runner.name}</a>` : runner.name || ''}</td>
                    <td class="py-3 px-5">${countryDisplay}</td>
                    <td class="py-3 px-5">${runner.time || ''}</td>
                    <td class="py-3 px-5">${runner.ageGroup || ''}</td>
                    <td class="py-3 px-5">${runner.gender || ''}</td>
                    <td class="py-3 px-5 text-white font-semibold">${runner.raceScore || ''}</td>
                `;
            });
            updatePaginationControls(totalPages, visibleRows.length);
        }

        function updatePaginationControls(totalPages, totalVisibleRows) {
            const pageInfo = document.getElementById('pageInfo');
            if (totalPages > 0) {
                pageInfo.textContent = `Sayfa ${currentPage} / ${totalPages}`;
            } else {
                pageInfo.textContent = 'Sayfa 0 / 0';
            }
            
            document.getElementById('prevPageButton').disabled = currentPage === 1;
            document.getElementById('nextPageButton').disabled = currentPage === totalPages || totalPages === 0;
            document.getElementById('rowsPerPageSelect').style.display = totalVisibleRows > 0 ? '' : 'none';
        }

        function updateCountryFilter() {
            const countryFilter = document.getElementById('countryFilter');
            const selectedValue = countryFilter.value;
            const countrySet = new Set(allRunnersData.map(r => r.country).filter(Boolean));
            
            const sortedCountries = Array.from(countrySet).sort((a, b) => {
                const nameA = countryCodeMap[a]?.name || a;
                const nameB = countryCodeMap[b]?.name || b;
                return nameA.localeCompare(nameB, 'tr');
            });
            
            countryFilter.innerHTML = '<option value="">T√ºm √úlkeler</option>'; 
            
            sortedCountries.forEach(countryCode3 => {
                const countryInfo = countryCodeMap[countryCode3];
                const option = document.createElement('option');
                option.value = countryCode3;
                
                if (countryInfo) {
                    const flag = getFlagEmoji(countryInfo.code);
                    option.textContent = `${flag} ${countryInfo.name}`;
                } else {
                    option.textContent = countryCode3; // Fallback
                }
                
                countryFilter.appendChild(option);
            });
            countryFilter.value = selectedValue;
        }

        function resetProcess() {
            document.getElementById('filterInput').value = '';
            document.getElementById('countryFilter').value = '';
            document.getElementById('genderFilter').value = '';
            currentPage = 1;
            
            document.querySelectorAll('#resultsTable th').forEach(header => {
                header.dataset.sortDir = '';
                header.querySelector('.sort-indicator').textContent = '';
            });
            
            loadDataFromCsv();
        }

        // --- SORTING ---
        function sortTable(columnKey, direction) {
            allRunnersData.sort((a, b) => {
                let valA = a[columnKey];
                let valB = b[columnKey];
                let comparison = 0;

                if (columnKey === 'country') {
                    valA = countryCodeMap[valA]?.name || valA;
                    valB = countryCodeMap[valB]?.name || valB;
                }

                if (columnKey === 'time') {
                    comparison = timeToSeconds(valA) - timeToSeconds(valB);
                } else if (!isNaN(valA) && !isNaN(valB) && valA !== '' && valB !== '' && valA !== null && valB !== null) {
                    comparison = parseFloat(valA) - parseFloat(valB);
                } else {
                    comparison = String(valA || '').localeCompare(String(valB || ''), 'tr', { sensitivity: 'base' });
                }
                
                return direction === 'asc' ? comparison : -comparison;
            });
            
            document.querySelectorAll('#resultsTable th').forEach(header => {
                const indicator = header.querySelector('.sort-indicator');
                indicator.textContent = header.dataset.column === columnKey ? (direction === 'asc' ? ' ‚ñ≤' : ' ‚ñº') : '';
            });

            currentPage = 1;
            renderTable();
        }
        
        function timeToSeconds(timeStr) {
            if (!timeStr || timeStr.toUpperCase() === 'DNF') return Infinity;
            const parts = timeStr.split(':').map(Number);
            return parts.length === 3 ? parts[0] * 3600 + parts[1] * 60 + parts[2] : Infinity;
        }
        
        // --- EXPORT ---
        function exportToCsv() {
            const { visibleRows } = getFilteredRows();
            const headers = ["UTMB Race Year", "Name/Surname", "ITRA Link", "Country", "Time", "Age-Group", "Gender", "Race Score"].map(h => `"${h}"`).join(',');
            
            const rows = visibleRows.map(runner => {
                return [
                    runner.raceYear,
                    runner.name,
                    runner.itraLink,
                    runner.country,
                    runner.time,
                    runner.ageGroup,
                    runner.gender,
                    runner.raceScore
                ].map(val => `"${String(val || '').replace(/"/g, '""')}"`).join(',');
            });
            
            const csvContent = "data:text/csv;charset=utf-8," + [headers, ...rows].join('\n');
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "filtered_itra_results.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>

